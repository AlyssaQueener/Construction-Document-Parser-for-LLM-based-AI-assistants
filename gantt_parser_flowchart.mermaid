flowchart TD
    A["**parse_gantt_chart**(path, chart_format)"] --> B{chart_format == 'tabular'?}

    B -- Yes --> C["**camelot.read_pdf**(path)\nExtract table from PDF"]
    B -- No --> V["**visual.parse_gantt_chart_visual**(path)\nVisual/image-based parsing"]
    V --> Z["Return JSON string"]

    C --> D["**preprocess_df_and_check_column_names**(df)"]

    D --> D1["**clean_empty_strings**(df)\nReplace '' with None"]
    D1 --> D2["Drop all-NaN rows & columns"]
    D2 --> E{DataFrame empty?}

    E -- Yes --> F["Return\n{'Table Recognition': 'failed'}"]

    E -- No --> G{Columns are\nauto-generated\nsequential integers?}
    G -- Yes --> H["**rename_columns**(df)\nPromote first row to headers"]
    G -- No --> I["Keep existing column names"]

    H --> J["**match_column_names_with_task_properties**(df)"]
    I --> J

    J --> J1["For each column:\n**match**(column_name)\nRegex against known patterns\n(EN + DE)"]
    J1 --> J2["Build column_order mapping\nCount found_matches"]

    J2 --> K{found_matches < 3?}

    K -- Yes --> L["**Fallback: Mistral AI**\npdfplumber extracts text\n→ mistral.call_mistral_for_columns()\n→ AI-based column identification"]
    K -- No --> M["Use regex-based\ncolumn_order"]

    L --> N["**create_tasks**(column_order, df)"]
    M --> N

    N --> N1["For each row in DataFrame:\nMap columns → Task fields\nusing column_order"]
    N1 --> N2["Validate & create\n**Task** Pydantic objects"]
    N2 --> O["Serialize tasks list\nto JSON string"]
    O --> Z

    style A fill:#4A90D9,color:#fff,stroke:#2C5F8A
    style B fill:#F5A623,color:#fff,stroke:#C17D15
    style E fill:#F5A623,color:#fff,stroke:#C17D15
    style G fill:#F5A623,color:#fff,stroke:#C17D15
    style K fill:#F5A623,color:#fff,stroke:#C17D15
    style F fill:#D0021B,color:#fff,stroke:#9B0114
    style Z fill:#7ED321,color:#fff,stroke:#5A9A17
    style L fill:#9B59B6,color:#fff,stroke:#6C3483
    style V fill:#9B59B6,color:#fff,stroke:#6C3483
