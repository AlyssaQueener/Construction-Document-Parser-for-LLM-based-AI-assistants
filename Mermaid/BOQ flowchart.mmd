flowchart TD
    subgraph Input
        A[BOQ PDF Document]
    end
    
    subgraph Extraction
        B[Camelot read_pdf<br/>flavor: stream]
        C[Table Object]
        B --> C
    end
    
    subgraph Preprocessing
        D[cam_stream_merge<br/>Flatten Tables]
        E[Merge Broken Lines<br/>Continuation Logic]
        F[detect_column_headers<br/>Identify or Apply Headers]
        G[Map Numeric Keys<br/>to Column Names]
        H[Formatted JSON List]
        D --> E --> F --> G --> H
    end
    
    subgraph AI_Processing
        I[json.dumps<br/>Stringify]
        J[create_preprocessed_prompt<br/>Build Instructions]
        K[Gemini API<br/>call_gemini_return_json]
        I --> J --> K
    end
    
    subgraph Output
        L[Structured JSON<br/>Sections & Items]
    end
    
    Input ==> Extraction
    Extraction ==> Preprocessing
    Preprocessing ==> AI_Processing
    AI_Processing ==> Output
    
    style A fill:#bbdefb
    style F fill:#fff59d
    style K fill:#fff59d
    style L fill:#c8e6c9