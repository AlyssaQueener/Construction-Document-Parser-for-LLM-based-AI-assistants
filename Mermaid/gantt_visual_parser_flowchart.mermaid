flowchart TD
    A["parse_gantt_chart_visual(path, option)"] --> C{"option"}
    C --> |full ai| C1["Full AI Parsing"]
    C --> |hybrid| D["Hybrid Visual Parsing"]

    %% ===== FULL AI BRANCH =====
    C1 --> F1["convert_pdf2img(path)"]
    F1 --> F2["call_mistral_timeline(image, 'check for timeline')"]
    F2 --> F3{"timeline_present?"}
    F3 --> |yes| F4["option = 'w timeline'"]
    F3 --> |no| F4b["option unchanged"]
    F4 --> F5["Extract table from PDF via pdfplumber"]
    F4b --> F5
    F5 --> F6["extract_activities_for_full_ai(df)\n(first 6 columns)"]
    F6 --> F7["extract_timeline_rows(df)"]
    F7 --> F8{"activities found?"}
    F8 --> |yes| F9["call_mistral_timeline(image,\n'full ai w activities', activities)"]
    F8 --> |no| F10{"to_be_chunked(image)?"}
    F10 --> |yes| F11["parse_from_chunks(path, option)"]
    F10 --> |no| F12["call_mistral_timeline(image, 'full ai')"]
    F11 --> F13["Split PDF into image chunks\n(with or without timeline header)"]
    F13 --> F14["For each chunk:\ncall_mistral_timeline → parse JSON"]
    F14 --> F15["Aggregate parsed results"]
    F9 --> FOUT["Clean up temp images\nReturn result"]
    F12 --> FOUT
    F15 --> FOUT

    %% ===== HYBRID VISUAL BRANCH =====
    D --> D1["convert_pdf2img(path)"]
    D1 --> D2["Extract table & rectangles\nfrom PDF via pdfplumber"]
    D2 --> D3["extract_activities(df)\n(first column values)"]
    D3 --> D4{"activities valid?\n(not None, count ≥ rowCount - 5)"}
    D4 --> |no| D5["call_mistral_activities(image)\n(AI fallback)"]
    D4 --> |yes| D6["extract_timeline_rows(df)\n(scan first 3 rows for time labels)"]
    D5 --> D6
    D6 --> D7["create_single_timeline(rows)\n(merge granular + coarse rows)"]
    D7 --> D8{"timeline valid?\n(count ≥ colCount - 5 and ≥ 4)"}
    D8 --> |no| D9["call_mistral_timeline(image,\n'no timeline')\n→ ai_extraction = True"]
    D8 --> |yes| D10["ai_extraction = False"]
    D9 --> D11["localize_timestamps(timeline, page)\n(find bounding boxes on PDF)"]
    D10 --> D11
    D11 --> D12{"too many unfound timestamps?\n(unfound > len - tolerance)\nand ai_extraction == False"}
    D12 --> |yes| D13["call_mistral_timeline(image,\n'badly extracted')\n→ re-localize"]
    D12 --> |no| D14["localize_activities(activities, page)\n(find bounding boxes on PDF)"]
    D13 --> D14
    D14 --> D15{"too many unfound activities?\n(unfound > len - tolerance)"}
    D15 --> |yes| D16["call_mistral_activities(image)\n→ re-localize"]
    D15 --> |no| D17["find_bars(rectangles,\nactivities_with_loc, tolerance)\n(match bars by vertical alignment)"]
    D16 --> D17
    D17 --> D18["check_bar_recognition()\n(validate bar distribution)"]
    D18 --> D19{">80% same count?\n(likely grid lines)"}
    D19 --> |yes| D20["identify_bars_with_colours()\n(filter background colors)"]
    D19 --> |no| D21["match_bars_with_timeline()\n(horizontal alignment check)"]
    D20 --> D21
    D21 --> D22["determine_start_end_of_activity()\n(min/max column index → dates)"]
    D22 --> DOUT["Return activities_with_dates"]

    %% ===== STYLING =====
    classDef decision fill:#fff3cd,stroke:#ffc107,color:#000
    classDef ai fill:#e8daef,stroke:#8e44ad,color:#000
    classDef process fill:#d4edda,stroke:#28a745,color:#000
    classDef output fill:#cce5ff,stroke:#007bff,color:#000

    class C,D4,D8,D12,D15,D19,F3,F8,F10 decision
    class D5,D9,D13,D16,F2,F9,F12,F14 ai
    class FOUT,DOUT output