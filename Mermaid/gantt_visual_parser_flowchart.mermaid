flowchart TD
    A["parse_gant_chart_visual(path)"]
    A --> B["PDF Processing: Table and Rectangle Extraction (pdfplumber)"]

    B --> B3[/"Rectangles"/]

    B --> C[/"DataFrame"/]

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% ACTIVITY EXTRACTION
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    C --> D["Extract activities from first column"]
    D --> D1{"Sufficient len(activities)?"}
    D1 -->|"Yes"| E["Localize activities on page (pdfplumber text search)"]
    D1 -->|"No"| D2["ðŸ¤– Mistral: Extract activities from chart (image)"]
    D2 --> E

    E --> E1{"Activities found > 80% ?"}
    E1 -->|"Yes"| F[/"Activities with bounding boxes"/]
    E1 -->|"No â€” retry"| E2["ðŸ¤– Mistral: Re-extract activities from chart image"]
    E2 --> E3["Localize again on page"]
    E3 --> F

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% TIMELINE EXTRACTION
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    C --> G["Extract timeline rows (first 3 DataFrame rows)"]
    G --> G1["Merge into single timeline (most granular row + context)"]
    G1 --> G2{"Sufficient timestamps?"}
    G2 -->|"Yes"| H["Localize timestamps on page (pdfplumber text search)"]
    G2 -->|"No"| G3["ðŸ¤– Mistral: Extract timeline from chart image"]
    G3 --> H

    H --> H1{"Most timestamps found on page?"}
    H1 -->|"Yes"| I[/"Timeline with bounding boxes"/]
    H1 -->|"No â€” retry"| H2["ðŸ¤– Mistral: Re-extract timeline from chart image"]
    H2 --> H3["Localize again on page"]
    H3 --> I

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% BAR MATCHING
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    F --> J["Match rectangles to activities (vertical alignment)"]
    B3 --> J
    J --> J1{"Bar recognition-valid?"}
    J1 -->|"Yes"| K["Activity â†’ Bar mapping"]
    J1 -->|"No â€” grid lines detected"| J2["Filter by colour (remove bright backgrounds)"]
    J2 --> K

    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    %% DATE RESOLUTION
    %% â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    K --> L["Match bars with timeline (horizontal alignment)"]
    I --> L
    L --> M["Determine start & end per activity (min/max column index)"]
    M --> O[/"Parsed activities with dates"/]

    %% â”€â”€ Styling â”€â”€
    classDef ai fill:#e8d5f5,stroke:#7c3aed,stroke-width:2px,color:#1e1e1e
    classDef decision fill:#fef3c7,stroke:#d97706,stroke-width:2px,color:#1e1e1e
    classDef data fill:#dbeafe,stroke:#2563eb,stroke-width:2px,color:#1e1e1e
    classDef process fill:#f1f5f9,stroke:#475569,stroke-width:1px,color:#1e1e1e
    classDef output fill:#d1fae5,stroke:#059669,stroke-width:2px,color:#1e1e1e

    class D2,E2,G3,H2 ai
    class D1,E1,G2,H1,J1 decision
    class C,F,I,K data
    class A,B,B1,B2,B3,D,E,E3,G,G1,H,H3,J,J2,L,M process
    class O output